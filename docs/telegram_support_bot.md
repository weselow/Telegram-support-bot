# Техническое задание

## 1. Общая информация

**Проект:** Telegram-бот техподдержки для сайта  
**Цель:** Организовать качественный, устойчивый и масштабируемый канал поддержки пользователей через Telegram с использованием бота и супергруппы с Topics (форум).

**Ключевой принцип:** качество важнее скорости реализации.

---

## 2. Общая концепция решения

- Пользователь общается **только с ботом в личных сообщениях (DM)**.
- Для каждого обращения создаётся **отдельный топик** в одной общей супергруппе поддержки.
- Бот полностью зеркалит переписку:
  - сообщения пользователя → в топик
  - ответы сотрудников в топике → пользователю
- Пользователь **не добавляется в группу** и не видит её напрямую.

---

## 3. Архитектура

### 3.1 Компоненты
- Telegram Bot
- Telegram Supergroup (Support) с включёнными Topics
- Backend сервиса бота
- База данных Postgres
- Сайт (источник перехода пользователя)

### 3.2 Технологический стек

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Язык | TypeScript | Типобезопасность, экосистема |
| Runtime | Node.js 20 LTS | Стабильность, async I/O |
| Telegram SDK | grammY | Активная поддержка, типизация, conversations |
| База данных | PostgreSQL 16 | Надёжность, ACID |
| ORM | Prisma | Типизированные запросы, миграции |
| Job Queue | BullMQ + Redis | SLA-таймеры, надёжные задачи |
| Логирование | Pino | Быстрый, структурированный JSON |

### 3.3 Инфраструктура

**Платформа:** VPS + Docker

**Минимальные требования к VPS:**
- CPU: 1 vCPU
- RAM: 2 GB
- Диск: 20 GB SSD
- OS: Ubuntu 22.04 LTS / Debian 12

**Docker-композиция:**
- `app` — Node.js приложение (бот)
- `postgres` — PostgreSQL 16
- `redis` — Redis 7 (для BullMQ)

**Режим работы Telegram:** Long-polling (не требует публичного IP/домена)

**Деплой:** Docker Compose, образы собираются локально или через CI

### 3.4 Роли
- **Пользователь** — клиент сайта
- **Сотрудник поддержки** — отвечает в топиках
- **Старший контакт** — эскалация SLA (первый в списке сотрудников)

Ролевая модель (оператор/админ) пока не используется.

---

## 4. Вход пользователя (Entry point)

### 4.1 Кнопка на сайте

На сайте размещается кнопка:
> «Написать в техподдержку в Telegram»

Ссылка вида:
```
https://t.me/<bot_username>?start=<payload>
```

### 4.2 Payload

Передаётся (опционально):
- **URL страницы**, с которой пользователь инициировал обращение.

Формат: `base64url(page_url)`

**Поведение:**
- Payload есть → сохраняем URL в тикете
- Payload нет или невалидный → работаем без контекста страницы
- Пользователь может написать боту напрямую (без перехода с сайта)

**Без защиты (HMAC, TTL)** — добавим при необходимости, если будет абуз.

---

## 5. Интейк (сбор данных)

Формат: **пошаговый диалог**

### 5.1 Сценарий (до создания тикета)

1. Пользователь нажимает /start (или переходит по ссылке)
2. Бот приветствует и объясняет формат:
   > «Здравствуйте! Опишите ваш вопрос или проблему.»
3. Пользователь отправляет описание
4. Бот создаёт тикет и топик
5. Бот подтверждает:
   > «Обращение #123 создано. Вы можете отправлять фото, видео, файлы и голосовые сообщения.»

### 5.2 Телефон (после создания тикета)

Отдельным сообщением в чате:
> «На случай, если Telegram будет работать нестабильно — оставьте, пожалуйста, номер телефона для связи (опционально).»

- Телефон **опциональный**
- Валидация не требуется — принимаем любой текст
- Если пользователь ответил — сохраняем в тикет

---

## 6. Создание тикета

### 6.1 Логика

**Принцип: один пользователь = один тикет** (один чат с ботом = один топик)

- Если у пользователя **нет тикета** → создаём новый
- Если тикет **активный** (Новый / В работе / Ждём клиента) → сообщения идут в него
- Если тикет **закрыт** → переоткрываем (статус → «Новый»), сообщения идут в тот же топик

**Преимущества:**
- Вся история общения с пользователем в одном топике
- Простая логика для пользователя
- Нет путаницы с множественными тикетами

**Кнопка «Создать новое обращение»** — не нужна.

### 6.2 Топик

Для каждого пользователя:
- Создаётся один Topic при первом обращении
- topic_id сохраняется в БД и используется для всех последующих обращений

---

## 7. Карточка тикета (первое сообщение в топике)

### 7.1 Содержимое (минимум)

- Telegram user (имя, @username если есть)
- Телефон (если указан)
- Текущий статус
- Inline-кнопки управления статусом

Карточка **закрепляется** в топике.

### 7.2 Обновление карточки

При изменениях (статус, телефон):
1. **Редактируем** закреплённое сообщение (актуальные данные)
2. **Пишем** отдельное сообщение в топик («Статус изменён: В работе → Закрыт»)

### 7.3 Телефон при переоткрытии

Если тикет переоткрывается и телефон уже есть:
> «Ваш номер для связи: +7... — всё верно?»
> [Да] [Изменить]

- «Да» → продолжаем
- «Изменить» → запрашиваем новый номер

---

## 8. Статусы тикета

### 8.1 Набор статусов

| Статус | Описание |
|--------|----------|
| **Новый** | Создан / переоткрыт, никто не взял |
| **В работе** | Сотрудник работает над обращением |
| **Ждём клиента** | Задан вопрос, ожидаем ответа |
| **Закрыт** | Обращение завершено |

### 8.2 Управление статусами

**Сотрудники:** полный контроль через inline-кнопки под карточкой

**Клиент:** может только закрыть тикет
- Кнопка в боте: «Спасибо, вопрос решён»
- При нажатии → статус «Закрыт»

### 8.3 Автоматическая смена статуса

| Событие | Действие |
|---------|----------|
| Сотрудник ответил (статус «Новый») | → В работе |
| Клиент ответил (статус «Ждём клиента») | → В работе |
| 7 дней без ответа клиента | → Закрыт (автозакрытие) |

### 8.4 Логирование

Каждое изменение статуса:
- Сохраняется в БД
- Публикуется системным сообщением в топике

---

## 9. Коммуникация

### 9.1 Зеркалирование сообщений

**Способ:** копирование контента, отправка от имени бота (не forward)

**Поддерживаемые типы:**
- текст
- фото
- видео
- документы
- аудио
- voice
- контакт
- геолокация
- стикеры
- GIF (анимации)

**Подписи:** не добавляются (из контекста понятно кто пишет)

### 9.2 Редактирование и удаление сообщений

**Редактирование:** синхронизируется
- Пользователь отредактировал в DM → обновляем в топике
- Сотрудник отредактировал в топике → обновляем в DM

**Удаление:** синхронизируется
- Пользователь удалил в DM → удаляем в топике
- Сотрудник удалил в топике → удаляем в DM

### 9.3 Пересылка

**Пересылаются клиенту:**
- Все сообщения от сотрудников (участников группы)

**Не пересылаются клиенту (системные):**
- Сообщения от бота (SLA-напоминания, пинги, смена статуса)
- Карточка тикета

### 9.4 Блокировка бота

Если пользователь заблокировал бота:
- Сообщение не доставляется
- В топик отправляется уведомление: «Пользователь заблокировал бота, сообщение не доставлено»
- Ошибка логируется

---

## 10. Сотрудники поддержки

### 10.1 Принцип

**Права наследуются из Telegram-группы:**
- Участник супергруппы = сотрудник поддержки
- Все сотрудники равны (без ролей)
- Отдельная регистрация не нужна

### 10.2 Кто может отвечать

Любой участник супергруппы поддержки может:
- Писать в топиках (сообщения пересылаются клиенту)
- Менять статус тикета

### 10.3 Старший контакт (для SLA-эскалации)

Определяется из админов супергруппы:
- Админы группы = старшие контакты
- При SLA-эскалации пингуются все админы

---

## 11. SLA и автоматизация

### 11.1 Рабочие часы

**Пока 24/7** — без ограничений по времени. Настраиваемые часы добавим позже при необходимости.

### 11.2 Напоминания (таймеры)

| Время без ответа | Действие |
|------------------|----------|
| **10 минут** | Пинг всех участников в топике (@user1 @user2...) |
| **30 минут** | Повторный пинг + пинг админов группы |
| **2 часа** | SLA breach: пинг в топике + личное сообщение админам |

Все напоминания — системные сообщения бота (не пересылаются клиенту).

### 11.3 Ожидание клиента

Статус «Ждём клиента»:
- Напоминание сотрудникам через 24 часа
- Автозакрытие через 7 дней без ответа клиента

---

## 12. Хранилище данных (Postgres)

### 12.1 Таблицы

**users** (один пользователь = одна запись навсегда)
- id (PK)
- tg_user_id (unique)
- tg_username
- tg_first_name
- topic_id
- status (enum: new, in_progress, waiting_client, closed)
- phone
- source_url (последний)
- created_at
- updated_at

**ticket_events** (история обращений и событий)
- id (PK)
- user_id (FK → users)
- event_type (enum: opened, reopened, closed, status_changed, phone_updated)
- old_value
- new_value
- question (описание проблемы при открытии/переоткрытии)
- source_url (URL при открытии/переоткрытии)
- created_at

**messages_map** (для синхронизации сообщений)
- id (PK)
- user_id (FK → users)
- dm_message_id
- topic_message_id
- direction (enum: user_to_support, support_to_user)
- created_at

---

## 13. Надёжность и нефункциональные требования

### 13.1 Восстановление после падения

- Бот получает пропущенные сообщения из очереди Telegram (long-polling)
- Обрабатывает их в обычном режиме
- Потеря сообщений недопустима

### 13.2 Бэкапы

**Для локальной PostgreSQL:**
- Ежедневный pg_dump
- Хранение последних 7 бэкапов

**Для managed БД (Supabase):** автобэкапы провайдера

### 13.3 Логирование

**Инструмент:** Sentry

**Что логируется:**
- Все входящие/исходящие сообщения (для отладки)
- Ошибки и исключения
- Смены статусов
- SLA-события (напоминания, breach)

### 13.4 Данные

- Персональные данные — только в PostgreSQL
- Медиафайлы — не хранятся (только file_id от Telegram)

### 13.5 Конфигурация

**Переменные окружения (.env):**
- `BOT_TOKEN` — токен Telegram-бота
- `SUPPORT_GROUP_ID` — ID супергруппы поддержки
- `DATABASE_URL` — подключение к PostgreSQL
- `REDIS_URL` — подключение к Redis
- `SENTRY_DSN` — DSN для Sentry

**Файл конфигурации (config.json):**
- Тексты сообщений бота (приветствие, подтверждения, кнопки)
- Таймеры SLA (10 мин, 30 мин, 2 часа)
- Прочие настройки без перекомпиляции

---

## 14. Критерии приёмки

- Тикет создаётся из бота, топик появляется автоматически
- Все сообщения доставляются ≤ 2 секунд
- Reply работает корректно
- Вложения пересылаются в обе стороны
- Статусы меняются кнопками
- SLA-напоминания срабатывают
- После перезапуска данные не теряются

---

## 15. Результат

Готовый Telegram-бот, обеспечивающий:
- изолированное общение пользователя
- структурированную работу поддержки
- масштабируемую модель тикетов
- высокий уровень качества обслуживания

