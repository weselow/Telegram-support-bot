# Widget HTTP 401 Handling

**Дата:** 2025-12-30
**Источник:** TD-030

## Проблема

При получении HTTP 401 (сессия не найдена) виджет выбрасывал ошибку и переставал работать. Пользователь терял возможность отправлять сообщения до перезагрузки страницы.

## Причина

Метод `request()` в `http.ts` не обрабатывал 401 ошибку особым образом — просто выбрасывал `ChatHttpError`.

## Решение

Добавлена автоматическая переинициализация сессии при 401:

1. Разделён `request()` на два метода:
   - `rawRequest()` — базовый запрос без retry
   - `request()` — с автоматическим восстановлением сессии

2. Логика восстановления:
   - При получении 401 вызывается `init()` для создания новой сессии
   - Оригинальный запрос повторяется
   - Флаг `isReinitializing` предотвращает бесконечные циклы

3. `init()` использует `rawRequest()` чтобы избежать рекурсии

## Изменённые файлы

- `chat-widget/src/transport/http.ts` — добавлена retry-логика при 401

## Важно для разработчика

- `rawRequest()` — для запросов без retry (используется в `init()`)
- `request()` — для всех остальных запросов (автоматический retry при 401)
- При добавлении новых HTTP методов использовать `request()`, не `rawRequest()`
