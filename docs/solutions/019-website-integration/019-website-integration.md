# 019: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º ‚Äî endpoint /ask-support

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** HIGH
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Redis (–µ—Å—Ç—å), Docker (–µ—Å—Ç—å)

## –¶–µ–ª—å

–ü–æ–∑–≤–æ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ –±–æ—Ç–∞ —Å —Å–∞–π—Ç–∞ –ø–æ —Å—Å—ã–ª–∫–µ, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç (URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã, IP, –≥–æ—Ä–æ–¥).

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å

### 1. HTTP —Å–µ—Ä–≤–µ—Ä –≤ –±–æ—Ç–µ

- [ ] –î–æ–±–∞–≤–∏—Ç—å Express/Fastify –¥–ª—è HTTP endpoint
- [ ] `GET /ask-support` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π endpoint
- [ ] `GET /health` ‚Äî –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 2. Endpoint /ask-support

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å User-Agent (–æ—Ç—Å–µ—è—Ç—å –±–æ—Ç–æ–≤)
2. –ü–æ–ª—É—á–∏—Ç—å IP –∏–∑ `X-Forwarded-For` –∏–ª–∏ `X-Real-IP`
3. –ü–æ–ª—É—á–∏—Ç—å Referer (URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
4. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–æ—Ä–æ–¥ –ø–æ IP (DaData, —Å –∫–µ—à–µ–º –≤ Redis)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Redis —Å –∫–æ—Ä–æ—Ç–∫–∏–º ID (TTL 1 —á–∞—Å)
6. Redirect 302 ‚Üí `https://t.me/BOT_USERNAME?start=SHORT_ID`

**–ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤ (User-Agent):**
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π UA
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å: Googlebot, Bingbot, YandexBot, Baidu, curl, wget, python, Go-http, HeadlessChrome, PhantomJS
- Rate limit –ø–æ IP: 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –±–æ—Ç–µ

- [ ] –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å `startHandler` ‚Äî –µ—Å–ª–∏ payload –ø–æ—Ö–æ–∂ –Ω–∞ SHORT_ID
- [ ] –î–æ—Å—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis –ø–æ ID
- [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `sourceUrl`, `ip`, `city` –≤ —Ç–∏–∫–µ—Ç
- [ ] –ü–æ–∫–∞–∑–∞—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–∏–∫–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤)

### 4. GeoIP —á–µ—Ä–µ–∑ DaData

- [ ] –°–µ—Ä–≤–∏—Å `src/services/geoip.service.ts`
- [ ] –ö–µ—à –≤ Redis: `geoip:{ip}` ‚Üí `{city}`, TTL 7 –¥–Ω–µ–π
- [ ] Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å

### 5. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Website integration
SUPPORT_DOMAIN=support.example.com
DADATA_API_KEY=secret

# Bot username –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
BOT_USERNAME=your_support_bot
```

### 6. Docker / Caddy

- [ ] –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç 3000 –≤ docker-compose
- [ ] –î–æ–±–∞–≤–∏—Ç—å Caddy container –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- [ ] HTTPS –¥–ª—è –¥–æ–º–µ–Ω–∞ SUPPORT_DOMAIN

### 7. –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ç–∏–∫–µ—Ç–∞

–§–æ—Ä–º–∞—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤:
```
üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (@ivanpetrov)
üì± +7 999 123-45-67
üåê –ò—Å—Ç–æ—á–Ω–∏–∫: https://shop.com/product/123
üìç IP: 95.67.xx.xx (–°–∞—Ä–∞—Ç–æ–≤)
üìù –°—Ç–∞—Ç—É—Å: –ù–æ–≤—ã–π
```

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `docs/deployment/website-integration.md`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ Caddy
- [ ] –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∞–π—Ç–æ–≤

## –ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã

- `src/index.ts` ‚Äî –∑–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞
- `src/http/server.ts` ‚Äî –Ω–æ–≤—ã–π, HTTP —Å–µ—Ä–≤–µ—Ä
- `src/http/routes/ask-support.ts` ‚Äî –Ω–æ–≤—ã–π, endpoint
- `src/http/middleware/bot-filter.ts` ‚Äî –Ω–æ–≤—ã–π, —Ñ–∏–ª—å—Ç—Ä –±–æ—Ç–æ–≤
- `src/services/geoip.service.ts` ‚Äî –Ω–æ–≤—ã–π, GeoIP
- `src/bot/handlers/start.ts` ‚Äî –¥–æ—Ä–∞–±–æ—Ç–∫–∞
- `src/services/topic.service.ts` ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–∏–∫–µ—Ç–∞
- `src/config/env.ts` ‚Äî –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- `docker-compose.yml` ‚Äî –ø–æ—Ä—Ç 3000
- `.env.example` ‚Äî –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

## –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis

```
# Redirect –¥–∞–Ω–Ω—ã–µ (TTL 1 —á–∞—Å)
redirect:{shortId} ‚Üí { url: string, ip: string, city: string }

# GeoIP –∫–µ—à (TTL 7 –¥–Ω–µ–π)
geoip:{ip} ‚Üí { city: string }
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ö–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–æ—Ç
- [ ] –í —Ç–∏–∫–µ—Ç–µ –≤–∏–¥–Ω—ã: URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞, IP, –≥–æ—Ä–æ–¥
- [ ] –ë–æ—Ç—ã –æ—Ç—Å–µ–∏–≤–∞—é—Ç—Å—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 403)
- [ ] GeoIP –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
- [ ] HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Caddy
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è endpoint –∏ geoip —Å–µ—Ä–≤–∏—Å–∞

---

## –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

–û–∑–Ω–∞–∫–æ–º—å—Å—è —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º: [backlog-workflow-standard.md](../../standards/backlog-workflow-standard.md)
