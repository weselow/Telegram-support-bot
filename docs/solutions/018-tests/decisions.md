# Decisions: Tests

## Текущее состояние

**Jest конфигурация:**
- ESM preset настроен (ts-jest/presets/default-esm)
- Coverage thresholds = 60%
- Большинство файлов исключено из coverage

**Существующие тесты:**
- `start.test.ts` - 4 теста, 100% coverage

## Найденные проблемы

### 1. ESM + Prisma + Jest несовместимость

При попытке тестировать сервисы с моками возникает ошибка:
```
SyntaxError: Cannot use 'import.meta' outside a module
```

**Причина:** Prisma client использует `import.meta.url`, который не поддерживается Jest в режиме CommonJS трансформации.

**Варианты решения (требуют значительных усилий):**
1. Использовать `jest-esm-transformer` (экспериментальный)
2. Перейти на Vitest (нативная поддержка ESM)
3. Рефакторинг для dependency injection

### 2. payload.ts не существует

Упоминается в задаче, но файл не был реализован.

## Принятое решение

### Что реализовано

1. **Исправлен warning ts-jest** - добавлен `diagnostics.ignoreCodes: [151002]`

2. **Добавлены тесты для formatMessage** (8 тестов):
   - Подстановка одной переменной
   - Подстановка множества переменных
   - Числовые значения
   - Отсутствующие переменные (placeholder сохраняется)
   - Пустой объект vars
   - Шаблон без placeholders
   - Нулевое значение
   - Пустая строка

3. **messages.ts включен в coverage** - убран из исключений

### Что НЕ реализовано (технический долг)

1. **Unit тесты для сервисов** - требует рефакторинга или смены тест-раннера
2. **Integration тесты** - требует тестовой БД
3. **Тесты для handlers** - тесно связаны с Grammy API

## Coverage

Текущий результат:
- `start.ts` - 100%
- `messages.ts` - 85% (error handling в loadMessages не покрыт - строки 86, 93, 98)
- Глобальный threshold 60% - соблюдается (87.5% overall)

## Рекомендации на будущее

1. **Рассмотреть переход на Vitest** - лучше поддерживает ESM
2. **Dependency Injection** - упростит мокирование
3. **Отдельные pure-function модули** - легче тестировать
