# ะะฝัะตะณัะฐัะธั ั ัะฐะนัะพะผ

## ะะฑะทะพั

ะะพะปัะทะพะฒะฐัะตะปั ะบะปะธะบะฐะตั ะบะฝะพะฟะบั "ะะพะดะดะตัะถะบะฐ" ะฝะฐ ัะฐะนัะต โ ะฟะตัะตัะพะดะธั ัะตัะตะท redirect ัะตัะฒะธั โ ะพัะบััะฒะฐะตััั Telegram ั ะฑะพัะพะผ โ ะฑะพั ะทะฝะฐะตั ะพัะบัะดะฐ ะฟัะธััะป ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะตะณะพ ะณะตะพะปะพะบะฐัะธั.

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโ
โ    ะกะฐะนั     โ โโโบ โ  /ask-support endpoint       โ โโโบ โ   Telegram   โ
โ   (ะบะปะธะบ)    โ     โ  (Fastify HTTP ัะตัะฒะตั)       โ     โ              โ
โโโโโโโโโโโโโโโ     โ                              โ     โโโโโโโโฌโโโโโโโโ
                    โ  1. Rate limit ะฟะพ IP         โ            โ
                    โ  2. ะัะพะฒะตัะบะฐ User-Agent      โ            โ
                    โ  3. ะะพะปััะตะฝะธะต IP + Referer   โ            โ
                    โ  4. GeoIP โ ะณะพัะพะด (DaData)   โ            โ
                    โ  5. ะกะพััะฐะฝะตะฝะธะต ะฒ Redis       โ            โ
                    โ  6. Redirect ะฒ Telegram      โ            โ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ            โ
                                                                โผ
                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโ
                                                   โ  ะะพั                   โ
                                                   โ  - ะะพะปััะฐะตั SHORT_ID   โ
                                                   โ  - ะะพััะฐัั ะธะท Redis    โ
                                                   โ  - ะกะพะทะดะฐัั ัะธะบะตั       โ
                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะฝัะตะณัะฐัะธั ะฝะฐ ัะฐะนัะต

### ะะดะฝะฐ ัััะปะบะฐ ะดะปั ะฒัะตั ัะฐะนัะพะฒ

```html
<a href="https://support.yoursite.com/ask-support" class="support-button">
  ๐ฌ ะัะถะฝะฐ ะฟะพะผะพัั?
</a>
```

Referer ะฟะตัะตะดะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฑัะฐัะทะตัะพะผ.

### ะะฐะถะฝะพ

- ะกััะปะบะฐ ะดะพะปะถะฝะฐ ะฑััั ะพะฑััะฝะพะน `<a>`, ะฝะต ัะตัะตะท JavaScript
- ะะต ะดะพะฑะฐะฒะปััั `rel="noreferrer"` โ ะธะฝะฐัะต Referer ะฝะต ะฟะตัะตะดะฐัััั
- HTTPS โ HTTPS ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ

---

## ะงัะพ ัะพะฑะธัะฐะตััั

| ะะฐะฝะฝัะต | ะััะพัะฝะธะบ | ะะพะบะฐะทัะฒะฐะตััั |
|--------|----------|--------------|
| URL ัััะฐะฝะธัั | Referer header | ะะณะตะฝัะฐะผ ะฒ ัะธะบะตัะต |
| IP ะฐะดัะตั | X-Forwarded-For / request.ip | ะะณะตะฝัะฐะผ ะฒ ัะธะบะตัะต |
| ะะพัะพะด | DaData API ะฟะพ IP | ะะณะตะฝัะฐะผ ะฒ ัะธะบะตัะต |

**ะะพะปัะทะพะฒะฐัะตะปั IP ะฝะต ะฟะพะบะฐะทัะฒะฐะตััั.**

---

## ะะฐััะพัะบะฐ ัะธะบะตัะฐ (ะดะปั ะฐะณะตะฝัะพะฒ)

```
๐ ะขะธะบะตั

๐ค ะะพะปัะทะพะฒะฐัะตะปั: ะะฒะฐะฝ
๐ค Username: @ivanpetrov
๐ Telegram ID: 123456789
๐ฑ ะขะตะปะตัะพะฝ: +79991234567
๐ ะััะพัะฝะธะบ: https://shop.com/product/iphone-15
๐ ะะพัะพะด: ะกะฐัะฐัะพะฒ
๐ IP: 95.67.12.34
๐ ะกะพะทะดะฐะฝ: 27.12.2025, 12:30:45

ะกัะฐััั: ๐ ะะพะฒัะน
```

---

## ะะฐัะธัะฐ ะพั ะฑะพัะพะฒ

Endpoint `/ask-support` ะฟัะพะฒะตััะตั User-Agent ะธ ะฑะปะพะบะธััะตั:

- ะัััะพะน User-Agent
- ะะพะธัะบะพะฒัะต ะฑะพัั: `googlebot`, `bingbot`, `yandex`, `baidu`, `duckduckbot`, `sogou`, `exabot`
- ะัะฐัะปะตัั: `spider`, `crawler`, `scraper`, `bot/`
- CLI: `curl`, `wget`, `python`, `httpie`, `axios`, `node-fetch`, `go-http-client`
- Headless ะฑัะฐัะทะตัั: `headlesschrome`, `phantomjs`, `puppeteer`, `playwright`, `selenium`

ะัะธ ะฑะปะพะบะธัะพะฒะบะต ะฒะพะทะฒัะฐัะฐะตััั 403 Forbidden.

### Rate Limit

10 ะทะฐะฟัะพัะพะฒ ะฒ ะผะธะฝััั ั ะพะดะฝะพะณะพ IP. ะัะธ ะฟัะตะฒััะตะฝะธะธ:
- ะกัะฐััั: 429 Too Many Requests
- Header: `Retry-After: N` (ัะตะบัะฝะด ะดะพ ัะฑัะพัะฐ)

---

## ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

```env
# HTTP ัะตัะฒะตั
HTTP_PORT=3000

# Username ะฑะพัะฐ (ะฑะตะท @)
BOT_USERNAME=your_support_bot

# DaData API ะบะปัั ะดะปั GeoIP
DADATA_API_KEY=your-api-key
```

---

## ะะฝััะฐััััะบัััะฐ

### Docker Compose

```yaml
services:
  bot:
    # ... ัััะตััะฒัััะธะต ะฝะฐัััะพะนะบะธ
    ports:
      - "3000:3000"  # HTTP ัะตัะฒะตั ะดะปั /ask-support
    environment:
      - HTTP_PORT=3000
      - BOT_USERNAME=your_support_bot
      - DADATA_API_KEY=${DADATA_API_KEY}

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
    depends_on:
      - bot

volumes:
  caddy_data:
```

### Caddyfile

```
support.yoursite.com {
    reverse_proxy bot:3000
}
```

Caddy ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะปััะธั SSL ัะตััะธัะธะบะฐั ะพั Let's Encrypt.

### ะะฐะถะฝะพ: Trust Proxy

HTTP ัะตัะฒะตั ะฝะฐัััะพะตะฝ ั `trustProxy: true`, ะฟะพััะพะผั ะบะพััะตะบัะฝะพ ะฟะพะปััะฐะตั ัะตะฐะปัะฝัะน IP ะบะปะธะตะฝัะฐ ะธะท `X-Forwarded-For` header, ะบะพัะพััะน ะดะพะฑะฐะฒะปัะตั Caddy/nginx.

---

## ะกัะตะผะฐ ะดะฐะฝะฝัั ะฒ Redis

```
# Redirect ะดะฐะฝะฝัะต (TTL 1 ัะฐั)
redirect:{shortId} โ {
  ip: "95.67.12.34",
  sourceUrl: "https://shop.com/product/123",
  city: "ะกะฐัะฐัะพะฒ",
  geoipResponse: { ... },  // ะะพะปะฝัะน ะพัะฒะตั DaData
  createdAt: "2025-12-27T12:30:45.000Z"
}

# ะะพะฝัะตะบัั ะฟะพะปัะทะพะฒะฐัะตะปั (TTL 24 ัะฐัะฐ)
user_context:{tgUserId} โ {
  sourceUrl: "https://shop.com/product/123",
  sourceCity: "ะกะฐัะฐัะพะฒ",
  ip: "95.67.12.34",
  geoipResponse: { ... }
}

# GeoIP ะบะตั (TTL 7 ะดะฝะตะน)
geoip:{ip} โ {
  city: "ะกะฐัะฐัะพะฒ",
  fullResponse: { ... }
}

# Rate limit (TTL 60 ัะตะบัะฝะด)
rate:ip:{ip} โ count
```

---

## ะคะปะพั ะฟะพะปัะทะพะฒะฐัะตะปั

```
1. ะะปะธะบ ะฟะพ ะบะฝะพะฟะบะต ะฝะฐ ัะฐะนัะต
   โ
2. GET /ask-support
   โ
3. ะัะพะฒะตัะบะฐ rate limit (10 req/min ะฟะพ IP)
   โ
4. ะัะพะฒะตัะบะฐ User-Agent (ะฑะปะพะบ ะฑะพัะพะฒ)
   โ
5. ะะพะปััะตะฝะธะต IP ะธ Referer
   โ
6. ะะฐะฟัะพั GeoIP (DaData, ั ะบะตัะตะผ)
   โ
7. ะะตะฝะตัะฐัะธั short ID (8 ัะธะผะฒะพะปะพะฒ hex)
   โ
8. ะกะพััะฐะฝะตะฝะธะต ะฒ Redis (TTL 1 ัะฐั)
   โ
9. Redirect 302 โ t.me/BOT?start=SHORT_ID
   โ
10. Telegram ะพัะบััะฒะฐะตั ะฑะพัะฐ
    โ
11. /start ั payload โ ะฑะพั ะดะพััะฐัั ะดะฐะฝะฝัะต ะธะท Redis
    โ
12. ะกะพััะฐะฝะตะฝะธะต ะบะพะฝัะตะบััะฐ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั (TTL 24 ัะฐัะฐ)
    โ
13. ะะตัะฒะพะต ัะพะพะฑัะตะฝะธะต โ ัะพะทะดะฐะฝะธะต ัะธะบะตัะฐ ั ะดะฐะฝะฝัะผะธ
```

---

## API Endpoints

### GET /ask-support

ะัะฝะพะฒะฝะพะน endpoint ะธะฝัะตะณัะฐัะธะธ.

**ะฃัะฟะตัะฝัะน ะพัะฒะตั:**
- Status: 302 Found
- Location: `https://t.me/BOT_USERNAME?start=SHORT_ID`

**ะัะธะฑะบะธ:**
- 403 Forbidden โ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัะน User-Agent (ะฑะพั)
- 429 Too Many Requests โ ะฟัะตะฒััะตะฝ rate limit

### GET /health

Health check ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ.

**ะัะฒะตั:**
```json
{
  "status": "ok"
}
```

---

## ะคะฐะนะปั ัะตะฐะปะธะทะฐัะธะธ

| ะคะฐะนะป | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `src/http/server.ts` | Fastify HTTP ัะตัะฒะตั |
| `src/http/routes/ask-support.ts` | Endpoint /ask-support |
| `src/http/routes/health.ts` | Endpoint /health |
| `src/http/middleware/bot-filter.ts` | ะคะธะปััั ะฑะพัะพะฒ ะฟะพ User-Agent |
| `src/services/geoip.service.ts` | GeoIP ัะตัะตะท DaData ั ะบะตัะธัะพะฒะฐะฝะธะตะผ |
| `src/services/redirect-context.service.ts` | ะฅัะฐะฝะตะฝะธะต ะบะพะฝัะตะบััะฐ ะผะตะถะดั /start ะธ ะฟะตัะฒัะผ ัะพะพะฑัะตะฝะธะตะผ |
| `src/services/rate-limit.service.ts` | Rate limiting ะฟะพ IP |
| `src/bot/handlers/start.ts` | ะะฑัะฐะฑะพัะบะฐ payload ะธะท deep link |
| `src/bot/handlers/message.ts` | ะกะพะทะดะฐะฝะธะต ัะธะบะตัะฐ ั ะดะฐะฝะฝัะผะธ ะธะท ะบะพะฝัะตะบััะฐ |
| `src/services/topic.service.ts` | ะคะพัะผะธัะพะฒะฐะฝะธะต ะบะฐััะพัะบะธ ัะธะบะตัะฐ |
