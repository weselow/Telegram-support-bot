# =============================================================================
# Docker Compose для Telegram Support Bot
# =============================================================================
#
# ЗАПУСК:
#
#   Development (локальная сборка):
#     docker compose build        # собрать образ локально
#     docker compose up -d        # запустить все сервисы
#
#   Production (готовый образ из GitHub Container Registry):
#     docker compose pull app     # скачать образ из ghcr.io
#     docker compose up -d        # запустить все сервисы
#
#   Обновление только app (без перезапуска postgres/redis):
#     docker compose pull app
#     docker compose up -d --no-deps app
#
#   Откат на предыдущую версию:
#     docker compose pull app --quiet  # (изменить тег на :previous в image)
#     docker compose up -d --no-deps app
#
# ЛОГИКА:
#   - image: используется при `docker compose pull` (production)
#   - build: используется при `docker compose build` (development)
#   - Если есть оба — pull скачивает image, build собирает локально
#
# =============================================================================

name: support-bot

services:
  # ---------------------------------------------------------------------------
  # App - основное приложение (бот + HTTP сервер)
  # ---------------------------------------------------------------------------
  app:
    image: ghcr.io/weselow/telegram-support-bot:latest
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: support-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/support_bot
      - REDIS_URL=redis://redis:6379
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - support-bot-network

  # ---------------------------------------------------------------------------
  # PostgreSQL - основная база данных
  # Порты не открыты — доступ только из docker network (безопасно)
  # Для dev-доступа см. docker-compose.override.yml
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: support-bot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: support_bot
    volumes:
      - ./.volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - support-bot-network

  # ---------------------------------------------------------------------------
  # Redis - кэш, очереди BullMQ, rate limiting
  # Порты не открыты — доступ только из docker network (безопасно)
  # Для dev-доступа см. docker-compose.override.yml
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: support-bot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - ./.volumes/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - support-bot-network

networks:
  support-bot-network:
    driver: bridge
